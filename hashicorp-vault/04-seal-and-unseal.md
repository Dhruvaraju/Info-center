# What is sealing and un sealing

## How do vault protect data?
#encryption-key #master-key
- Vault saves all the data in storage backend
- Data stored in backend is encrypted by an `encryption key`
- This `Encryption key` is stored on vault node.
- Before storing encryption key on vault node, `Encryption key` is encrypted using a `master key`

### Master Key

Used to decrypt the `EncryptionKey`

- Created during vault initialization or during a rekey operation
- Never written to storage when using traditional unseal mechanism
- Written to core/master (storage backend) when using Auto Unseal

### Encryption Key

Used to encrypt/decrypt data written to storage backend

- Encrypted by master key
- Stored alongside the data in a keyring on the storage backend
- Can be easily rotated (Which is a manual operation)

## Seal and Unseal

- Vault always starts in a sealed state that means, it knows where to access the data, and how, but can't decrypt it.
- Almost no operations are possible when vault is in a sealed state. Only the below operations are possible
	- Only status check (Meaning is it in sealed on unsealed state)
	- Unsealing a vault 
- Unsealing the vault means the node can reconstruct the master key in order to decrypt the encryption key, and ultimately read the data.
- After unsealing the encryption key is stored in the memory.

**Sealing vault:** Means Vault throws away the encryption key and requires another unseal to do any further operation

> Vault starts in a sealed state, you can also seal it via UI, CLI or API.

## What is the need of sealing a vault?

- Key shards are inadvertently exposed (As of now think key shards  means your some credentials)
- Detection of a compromise or network intrusion.
- Spyware/malware on the Vault nodes

### Unsealing Options:

- Key Sharding (Using Sharmir algorithm) 
- Cloud Auto Unseal (can use AWS KMS)
- Transit Auto Unseal (With help of another Vault cluster or nodes)

## Un Sealing with Key Shards
#shards #unseal
- Vault data >> protected by Encryption key >> Encryption key is encrypted by  Master key
- Master key is broken into 5 pieces with **Shamir's secret sharing Algorithm** these are called as key **shards or unseal keys.**
- To unseal a Vault we need a threshold of keys generally it will be 3 out of 5
- Once we provide any 3 keys vault will generate master key from it and use it to generate encryption key, which in turn is used to encrypt or decrypt vault data.

To get status of vault use `vault status` it will give information such as 
- Seal type eg: Shamir
- Sealed true or false
- Total share which is number of shards
- Threshold : number of keys required to unseal vault
- Unseal progress: Number of shards provide so far to unseal Vault

After providing the keys:
Once Vault is unsealed it will provide additional details such as:
- Vault version
- Storage type: Storage backend type
- Cluster Name: Name of Vault cluster
- Cluster ID: Which is the autogenerated ID of the cluster
- HA Enabled: true or false (High Availability mode enabled or not)

- Unsealing with key shards is the default option - No additional configuration required
- No Single person should have access to all key shards.
- Ideally each key shard should be stored by a different employee.
- While initializing Vault, you can request the individual shards to be encrypted with different PGP keys.
- Key shards should not be stored online and should be highly protected ideally stored encrypted.

### Basic commands used:

- To get vault status `vault status`
- To read the configuration file use `cat /etc/vault.d/vault.hcl` Initially there will not be any configuration related to sealing.
- To initialize vault cluster use `vault operator init` #vault_init
	- Once the command is executed we will get the 5 unseal keys and Initial root token to access vault
- To provide unseal keys use `vault opreater unseal` Vault will ask for shards, provide any one of the shards.
- After threshold is met, we should be able to get an unsealed status and we can start interacting with vault.
- To log in to vault use `vault login <<token>>` #vault_login
- To get list of secrets engine: `vault secrets list` #vault_secrets_list

## Unsealing with Auto Unseal
#auto_unseal #cloud_kms

- Vault Data -> encrypted by Encryption Key -> Encrypted key will be encrypted by Master Key -> Master key will be encrypted by a Key generated with Key generated with Cloud Key management Service (KMS)
- Master key will ne stored on Storage backend with vault data.
- Encryption key will be stored on Vault node.

- Auto unseal uses a cloud or on-premises HSM to decrypt the master key #one-prem_hsm
- Vault configuration file identifies the particular key to use for decryption
- Cloud Auto Unseal automatically unseals Vault upon service or node restarts.
- This option is available in both open source and enterprise editions
- This was a Enterprise option only until Vault 1.0 version

Requires an config file update:
The following section (seal stanza) need to be added without the comments

```
seal "awskms" { # identefies the type of seal mechanism for cluster
 region = "REGION" # Identefies the region where KMS key resides
 ksm_key_id = "KMSKEY" # Identefies the actual KMS key in AWS
}
```

- Got to any cloud key management system, create a key and copy those details to vault config
-  Once the config is updated, seal type will be changed to Recovery seal type.
- Initialize the vault with  `vault operator init`
- We will get 5 Recovery keys and a root token to perform operation on Vault.
- These 5 keys can be used when the vault is manually sealed.

## Unsealing with Transit Auto Unseal
#transit_auto_unseal

- Vault data is encrypted  by encryption key >> Encryption key is encrypted by Master key >> Master key will be encrypted by an Encryption key which will be in another vault cluster.
- The vault cluster in which the encryption key will be hosted for encrypting and decrypting master key will have a transit secrets engine.
- We can have a single vault cluster which is hosting transit secrets engine for many other vault clusters or we can share them across different clusters like vault A's encryption key will be on Vault B, Vault B's encryption key on Vault C.

- Unsealing with transit auto unseal will use the transit secret engine of  a different vault cluster.
- Transit secret engine may be configured in a namespace.
- Transit unseal supports key rotation.
- Available in open source and enterprise versions
- The core vault cluster must be highly-available

** Example Config to be added for Transit Auto Unseal**
```
seal "transit"{
address = "http:core-vault-cluster:8300" #Address of vault cluster running in transit
token = "s.GHiusadigJLHFGJfedgikGI"  # ACL token to use if enabled
disable_renewal = "false"

//Key con figuration
key_name = "transit_key_name"  # transit key name used for encryption decryption
mount_path = "transit/"  # mount path of transit key engine
namespace = "ns1/"  # name space of transit secret engine

// TLS Configuration
tls_ca_cert = "/etc/vault/ca_cert.pem"
tls_client_cert = "etc/vault/client_cert.pem"
tls_client_key = "etc/vault/client_cert.pem"
tls_server_name = "vault"
tls_skip_verify = "false"
}
```

## Setting up a transit secrets engine

- `vault secrets enable transit`  for enabling a transit engine in a vault cluster.
- `vault write -f transit/keys/unseal-key`  for creating a key named 'unseal-key' which can be used for encrypting master key of other vault cluster.
- `vault list transit/keys` will list all the keys created under transit secrets engine

example policy file
```hcl
# policy.hcl file
path "transit/encrypt/unseal-key" {
 capabilities = [ "update"]
}

path "transit/decrypt/unseal-key" {
 capabilities = [ "update"]
}
```

- `vault policy write unseal policy.hcl`  will add a new policy with name unseal
- `vault policy list` will list all the available policies
- `vault policy read <<policy_name>>` will display the content of a policy 
- `vault token create -policy=<<policy_name>>` this will generate a token which can be used to access the transit secrets engine.

In the other cluster use these details in the vault congiguration
```
seal "transit" {
	address    = "http://transit-vault-adress"
	token      = "token-generated-above"
	key_name   = "unseal-key"
	mount+path = "transit"
}
```

## Pros of Unseal options

- Key Shards
	- Simplest way to unseal
	- Works on any platform
	- Configuration options make it flexible
- Auto Unseal
	- Automated Unsealing of Vault
	- Set and forget
	- Integration benefits for running on same platform
- Transit Unseal
	- Automatic Unsealing of Vault
	- Set and forget vault
	- Platform Agnostic
	- Useful when running multiple Vault clusters

## Cons of Unseal Options

- Key Shards
	- Introduce risk for storing keys
	- Requires manual intervention for unsealing
	- Keys can be inadvertently shared and require rotation
- Auto unseal
	- Regional requirements for cloud HSMs
	- Cloud/Vendor lock-in
- Transit Auto Unseal
	- Requires a centralized vault cluster
	- Centralized Vault cluster needs the highest level of uptime.
